name: Promote Staging to Production

on:
  workflow_dispatch:
    inputs:
      confirm_promotion:
        description: 'Type "promote" to confirm promotion of staging to production'
        required: true
        type: string

jobs:
  promote-to-production:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_promotion == 'promote'
    
    env:
      APP_NAME: ${{ vars.STAGING_APP_NAME }}
      UPSTREAM_TOKEN: ${{ secrets.CPLN_TOKEN_STAGING }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        env:
          CPLN_TOKEN: ${{ secrets.CPLN_TOKEN_PRODUCTION }}
      
      - name: Copy Image from Staging
        run: cpflow copy-image-from-upstream -a "${APP_NAME}" -t "${UPSTREAM_TOKEN}" -v
      
      - name: Deploy Image to Production
        run: cpflow deploy-image -v
      
      - name: Create GitHub Release
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the current date in YYYY-MM-DD format
          RELEASE_DATE=$(date '+%Y-%m-%d')
          
          # Create a release tag
          RELEASE_TAG="production-${RELEASE_DATE}"
          
          # Create GitHub release
          gh release create "${RELEASE_TAG}" \
            --title "Production Release ${RELEASE_DATE}" \
            --notes "ðŸš€ Production deployment on ${RELEASE_DATE}"
