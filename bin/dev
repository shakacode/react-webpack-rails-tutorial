#!/usr/bin/env ruby
# frozen_string_literal: true

# ReactOnRails Development Server
#
# This script provides a simple interface to the ReactOnRails development
# server management. The core logic is implemented in ReactOnRails::Dev
# classes for better maintainability and testing.
#
# Before starting the Procfile processes, this script runs precompile tasks:
# 1. rescript:build - Compiles .res files to .res.js
# 2. react_on_rails:locale - Generates i18n JavaScript files
#
# This ensures all generated files exist before webpack starts watching.
#
# Each command uses a specific Procfile for process management:
# - bin/dev (default/hmr): Uses Procfile.dev
# - bin/dev static: Uses Procfile.dev-static-assets
# - bin/dev prod: Uses Procfile.dev-prod-assets
#
# To customize development environment:
# 1. Edit the appropriate Procfile to modify which processes run
# 2. Modify this script for project-specific command-line behavior
# 3. Extend ReactOnRails::Dev classes in your Rails app for advanced customization
# 4. Use classes directly: ReactOnRails::Dev::ServerManager.start(:development, "Custom.procfile")

require "bundler/setup"
require "react_on_rails/dev"
require_relative "../config/environment"

# Run precompile tasks before starting development server
# This ensures rescript and locale files are generated before webpack starts
def run_precompile_tasks
  puts "üì¶ Running precompile tasks..."

  # Build ReScript files first
  print "   ReScript build... "
  output = `yarn res:build 2>&1`
  if $?.success?
    puts "‚úÖ"
  else
    puts "‚ùå"
    puts "   Failed to build ReScript files:"
    output.each_line { |line| puts "   #{line}" }
    exit 1
  end

  # Generate locale files using ReactOnRails directly (avoids shell Ruby version issues)
  print "   Locale generation... "
  begin
    ReactOnRails::Locales.compile
    puts "‚úÖ"
  rescue StandardError => e
    puts "‚ùå"
    puts "   Failed to generate locales: #{e.message}"
    exit 1
  end

  puts ""
end

# Run precompile before starting the server (unless running kill or help commands)
unless ARGV.include?("kill") || ARGV.include?("-h") || ARGV.include?("--help")
  run_precompile_tasks
end

# Main execution
ReactOnRails::Dev::ServerManager.run_from_command_line(ARGV)